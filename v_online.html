<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Matematik Fonksiyon Laboratuvar覺 v3</title>
  <script src="https://www.geogebra.org/apps/deployggb.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 0; }
    #container { display: flex; height: 100vh; }
    #ggb-element { flex: 3; border-right: 2px solid #ccc; }
    #chat { flex: 1; display: flex; flex-direction: column; background: white; padding: 15px; min-width: 350px; }
    #messages { flex: 1; overflow-y: auto; border: 1px solid #eee; margin-bottom: 15px; padding: 10px; border-radius: 8px; font-size: 0.9rem; }
    .msg { margin-bottom: 12px; padding: 8px 12px; border-radius: 15px; line-height: 1.4; }
    .user-msg { background: #e3f2fd; align-self: flex-end; margin-left: 20%; border-bottom-right-radius: 2px; }
    .bot-msg { background: #f1f8e9; align-self: flex-start; margin-right: 20%; border-bottom-left-radius: 2px; }
    .error-msg { background: #ffebee; color: #c62828; font-size: 0.8rem; }
    #input-area { display: flex; gap: 8px; }
    input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
    button { padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 20px; cursor: pointer; }
    button:disabled { background: #ccc; }
  </style>
</head>
<body>

<div id="container">
  <div id="ggb-element"></div>

  <div id="chat">
    <h3 style="margin-top:0; color:#2e7d32;"> Matematik Asistan覺</h3>
    <div id="messages">
      <div class="msg bot-msg">Merhaba! Ben matematik 繹retmeninim. Fonksiyon d繹n羹羹mlerini kefetmeye haz覺r m覺s覺n? rnein "f(x)=x^2 癟iz" diyerek balayabilirsin.</div>
    </div>
    <div id="input-area">
      <input type="text" id="userInput" placeholder="Mesaj覺n覺z覺 yaz覺n..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" id="sendBtn">G繹nder</button>
    </div>
  </div>
</div>

<script>
    // GeoGebra Ayarlar覺
    var params = {
        "appName": "graphing",
        "width": 800,
        "height": 600,
        "showToolBar": false,
        "showAlgebraInput": true,
        "showMenuBar": false,
        "enableLabelDrags": false,
        "enableShiftDragZoom": true,
        "language": "tr"
    };
    var ggbApp = new GGBApplet(params, true);
    window.addEventListener("load", function() {
        ggbApp.inject('ggb-element');
    });

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const btn = document.getElementById("sendBtn");
      const text = input.value.trim();
      
      if (!text) return;

      addMessage("Siz", text, "user-msg");
      input.value = "";
      input.disabled = true;
      btn.disabled = true;

      try {
        // --- RENDER ADRES襤N襤Z BURAYA EKLEND襤 ---
        const renderURL = "https://fonksiyon-lab.onrender.com"; 
        
        const response = await fetch(`${renderURL}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userMessage: text, 
            studentId: "deney_grubu_1" 
          }),
        });

        if (!response.ok) throw new Error('Sunucu hatas覺');
        
        const data = await response.json();
        handleAiResponse(data);

      } catch (error) {
        addMessage("Sistem", "Balant覺 hatas覺! Sunucu uyan覺yor olabilir (yakla覺k 40 sn s羹